@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix sec: <https://example.org/sec/core#> .
@prefix inc: <https://example.org/incident#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix kgcs: <https://example.org/kgcs/shacl#> .
@prefix cve: <https://example.org/sec/cve#> .
@prefix cwe: <https://example.org/sec/cwe#> .
@prefix capec: <https://example.org/sec/capec#> .
@prefix attck: <https://example.org/sec/attck#> .
@prefix d3fend: <https://example.org/sec/d3fend#> .
@prefix car: <https://example.org/sec/car#> .
@prefix shield: <https://example.org/sec/shield#> .
@prefix engage: <https://example.org/sec/engage#> .

# Core SHACL shapes for KGCS Core + Incident safety

# 1) Forbid a direct edge from Vulnerability -> Technique (no CVE -> Technique shortcut)
# If any Vulnerability has an 'implemented_as' predicate pointing at a Technique, this shape fails.

sec:NoDirectVulnTechniqueShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-001" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#NoDirectVulnTechniqueShape> ;
  sh:targetClass sec:Vulnerability ;
  sh:property [
    a sh:PropertyShape ;
    sh:path sec:implemented_as ;
    sh:maxCount 0 ;
    sh:message "Direct Vulnerability -> Technique links are forbidden; use the canonical chain (Vulnerability -> Weakness -> AttackPattern -> Technique)." ] ;
.

# 2) Technique must belong to at least one Tactic
sec:TechniqueTacticShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-002" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#TechniqueTacticShape> ;
  sh:targetClass sec:Technique ;
  sh:property [
    a sh:PropertyShape ;
    sh:path sec:belongs_to ;
    sh:minCount 1 ;
    sh:message "A Technique must be linked to a Tactic (sec:belongs_to)." ;
    sh:class sec:Tactic ] ;
.

# 3) ObservedTechnique (Incident extension) must anchor to a Core Technique
inc:ObservedTechniqueAnchorShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-INC-001" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#ObservedTechniqueAnchorShape> ;
  sh:targetClass inc:ObservedTechnique ;
  sh:property [
    a sh:PropertyShape ;
    sh:path inc:instance_of ;
    sh:minCount 1 ;
    sh:class sec:Technique ;
    sh:message "ObservedTechnique must have an inc:instance_of link to a sec:Technique." ] ;
.

# 4) Incidents MUST NOT directly reference Vulnerabilities (claim-based separation)
# This uses a SPARQL constraint: any triple where the object is a Vulnerability is a violation.
sec:NoIncidentVulnerabilityShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-INC-002" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#NoIncidentVulnerabilityShape> ;
  sh:targetClass inc:Incident ;
  sh:select (
    [
      sh:prefixes (
        sec: <https://example.org/sec/core#> )
      sh:message "Incidents must not directly reference Vulnerability nodes; link via ObservedTechnique -> Technique -> ... instead."
      sh:select "SELECT $this ?p ?v WHERE { $this ?p ?v . ?v a sec:Vulnerability . }"
    ]
  ) ;
.

# Additional Core constraints

# Platform must provide a CPE URI or identifier
sec:PlatformCpeUriShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-003" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#PlatformCpeUriShape> ;
  sh:targetClass sec:Platform ;
  sh:property [ a sh:PropertyShape ; sh:path sec:cpeUri ; sh:minCount 1 ; sh:message "Platform must include a canonical CPE URI (sec:cpeUri)." ] ;
.

# PlatformConfiguration must include match criteria or an id
sec:PlatformConfigurationShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-004" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#PlatformConfigurationShape> ;
  sh:targetClass sec:PlatformConfiguration ;
  sh:property [ a sh:PropertyShape ; sh:path sec:configurationCriteria ; sh:minCount 1 ; sh:message "PlatformConfiguration must include configuration criteria (sec:configurationCriteria)." ] ;
.

# Vulnerability must be caused_by at least one Weakness (causal chain start)
sec:VulnerabilityCausedByShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-005" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#VulnerabilityCausedByShape> ;
  sh:targetClass sec:Vulnerability ;
  sh:property [ a sh:PropertyShape ; sh:path sec:caused_by ; sh:minCount 1 ; sh:class sec:Weakness ; sh:message "Vulnerability must be linked to at least one Weakness (sec:caused_by)." ] ;
.

# AttackPattern must implement into at least one Technique
sec:AttackPatternImplementsShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-006" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#AttackPatternImplementsShape> ;
  sh:targetClass sec:AttackPattern ;
  sh:property [ a sh:PropertyShape ; sh:path sec:implemented_as ; sh:minCount 1 ; sh:class sec:Technique ; sh:message "AttackPattern should be implemented by at least one Technique (sec:implemented_as)." ] ;
.

# VulnerabilityScore must declare a cvssVersion
sec:VulnerabilityScoreVersionShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-007" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#VulnerabilityScoreVersionShape> ;
  sh:targetClass sec:VulnerabilityScore ;
  sh:property [ a sh:PropertyShape ; sh:path sec:cvssVersion ; sh:minCount 1 ; sh:message "VulnerabilityScore must include a cvssVersion (e.g., '3.1', '4.0')." ] ;
.

# SubTechnique must have exactly one parent Technique
sec:SubTechniqueParentShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-ATTCK-001" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#SubTechniqueParentShape> ;
  sh:targetClass sec:SubTechnique ;
  sh:property [ a sh:PropertyShape ; sh:path sec:subtechnique_of ; sh:minCount 1 ; sh:maxCount 1 ; sh:class sec:Technique ; sh:message "SubTechnique must reference exactly one parent Technique via sec:subtechnique_of." ] ;
.

# Forbid Vulnerability -> Platform direct affects (must be PlatformConfiguration)
sec:NoVulnAffectsPlatformShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-008" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#NoVulnAffectsPlatformShape> ;
  sh:targetClass sec:Vulnerability ;
  sh:select (
    [
      sh:prefixes (sec: <https://example.org/sec/core#>)
      sh:message "Vulnerability must not directly affect a Platform; use PlatformConfiguration (sec:affects -> sec:PlatformConfiguration)."
      sh:select "SELECT $this ?p ?o WHERE { $this sec:affects ?o . ?o a sec:Platform . }"
    ]
  ) ;
.

# 1) External identifier presence for core node types (every core node must expose a stable external id)

sec:PlatformExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-009" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#PlatformExternalIdShape> ;
  sh:targetClass sec:Platform ;
  sh:or (
    [ sh:property ( [ a sh:PropertyShape ; sh:predicate sec:cpeUri ; sh:minCount 1 ] ) ]
    [ sh:property ( [ a sh:PropertyShape ; sh:predicate sec:cpeNameId ; sh:minCount 1 ] ) ]
  ) ;
  sh:message "Platform must expose a stable CPE identifier via sec:cpeUri or sec:cpeNameId." ;
.

sec:PlatformConfigurationExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-010" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#PlatformConfigurationExternalIdShape> ;
  sh:targetClass sec:PlatformConfiguration ;
  sh:property [ sh:predicate sec:matchCriteriaId ; sh:minCount 1 ; sh:message "PlatformConfiguration must include sec:matchCriteriaId." ] ;
.

sec:VulnerabilityExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-011" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#VulnerabilityExternalIdShape> ;
  sh:targetClass sec:Vulnerability ;
  sh:property [ a sh:PropertyShape ; sh:path sec:cveId ; sh:minCount 1 ; sh:message "Vulnerability must include sec:cveId." ] ;
.

sec:WeaknessExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-012" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#WeaknessExternalIdShape> ;
  sh:targetClass sec:Weakness ;
  sh:or (
    [ sh:property ( [ a sh:PropertyShape ; sh:path cwe:cwe_id ; sh:minCount 1 ] ) ]
    [ sh:property ( [ a sh:PropertyShape ; sh:path sec:cwe_id ; sh:minCount 1 ] ) ]
  ) ;
  sh:message "Weakness must include a CWE identifier (cwe:cwe_id or sec:cwe_id)." ;
.

sec:AttackPatternExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-013" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#AttackPatternExternalIdShape> ;
  sh:targetClass sec:AttackPattern ;
  sh:property [ a sh:PropertyShape ; sh:path capec:capec_id ; sh:minCount 1 ; sh:message "AttackPattern must include capec:capec_id." ] ;
.

sec:TechniqueExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-ATTCK-002" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#TechniqueExternalIdShape> ;
  sh:targetClass sec:Technique ;
  sh:or (
    [ sh:property ( [ a sh:PropertyShape ; sh:path attck:technique_id ; sh:minCount 1 ] ) ]
    [ sh:property ( [ a sh:PropertyShape ; sh:path sec:technique_id ; sh:minCount 1 ] ) ]
  ) ;
  sh:message "Technique must include an ATT&CK technique identifier (attck:technique_id)." ;
.

sec:TacticExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-ATTCK-003" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#TacticExternalIdShape> ;
  sh:targetClass sec:Tactic ;
  sh:property [ a sh:PropertyShape ; sh:path attck:tactic_id ; sh:minCount 1 ; sh:message "Tactic must include attck:tactic_id." ] ;
.

sec:DefensiveTechniqueExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-D3FEND-001" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#DefensiveTechniqueExternalIdShape> ;
  sh:targetClass sec:DefensiveTechnique ;
  sh:property [ a sh:PropertyShape ; sh:path d3fend:d3fendId ; sh:minCount 1 ; sh:message "DefensiveTechnique must include d3fend:d3fendId." ] ;
.

sec:DetectionAnalyticExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CAR-001" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#DetectionAnalyticExternalIdShape> ;
  sh:targetClass sec:DetectionAnalytic ;
  sh:property [ a sh:PropertyShape ; sh:path car:car_id ; sh:minCount 1 ; sh:message "DetectionAnalytic must include car:car_id." ] ;
.

sec:DeceptionTechniqueExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-SHIELD-001" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#DeceptionTechniqueExternalIdShape> ;
  sh:targetClass sec:DeceptionTechnique ;
  sh:property [ a sh:PropertyShape ; sh:path shield:shieldId ; sh:minCount 1 ; sh:message "DeceptionTechnique must include shield:shieldId." ] ;
.

sec:EngagementConceptExternalIdShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-ENGAGE-001" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#EngagementConceptExternalIdShape> ;
  sh:targetClass sec:EngagementConcept ;
  sh:property [ a sh:PropertyShape ; sh:path engage:engageId ; sh:minCount 1 ; sh:message "EngagementConcept must include engage:engageId." ] ;
.

# 2) Ensure references include source and URL for verifiability
sec:ReferenceCompletenessShape a sh:NodeShape ;
  kgcs:ruleId "KGCS-CORE-014" ;
  kgcs:provenance <https://example.org/docs/ontology/shacl/core-shapes.ttl#ReferenceCompletenessShape> ;
  sh:targetClass sec:Reference ;
  sh:property [ a sh:PropertyShape ; sh:path sec:referenceUrl ; sh:minCount 1 ; sh:message "Reference must include a referenceUrl." ] ;
  sh:property [ a sh:PropertyShape ; sh:path sec:referenceSource ; sh:minCount 1 ; sh:message "Reference must include a referenceSource." ] ;
.

# 3) Enforce canonical causal chain exists for Vulnerabilities (stronger SPARQL check)
sec:VulnerabilityCanonicalChainShape a sh:NodeShape ;
  sh:targetClass sec:Vulnerability ;
  sh:select (
    [
      sh:prefixes (sec: <https://example.org/sec/core#>)
      sh:message "Vulnerability must have the canonical causal chain: caused_by Weakness -> exploited_by AttackPattern -> implemented_as Technique." 
      sh:select "SELECT $this WHERE { FILTER NOT EXISTS { $this sec:caused_by ?w . ?w sec:exploited_by ?ap . ?ap sec:implemented_as ?t . } }"
    ]
  ) ;
.
